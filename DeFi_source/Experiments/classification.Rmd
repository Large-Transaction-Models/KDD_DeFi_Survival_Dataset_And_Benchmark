```{r}
# Load the libraries
library(survival)
library(randomForest)
library(caret)
library(ggplot2)
library(knitr)
library(dplyr)


source("../dataLoader.R")

select <- dplyr::select
rename <- dplyr::rename

allSurvivalData <- allSurvivalData %>%
  mutate(timeDiff = timeDiff/86400) # Convert time variable to days

borrowToRepay <- allSurvivalData %>%
  filter(`Index Event` == "borrow") %>%
  filter(`Outcome Event` == "repay") 
```

```{r}
# Define a time threshold for the binary classification (e.g., 365 days for 1 year)
time_threshold <- 365

# Create a binary target variable indicating if the event occurred within the threshold
data <- borrowToRepay %>%
  mutate(event_within_threshold = ifelse(timeDiff <= time_threshold & status == 1, 1, 0)) %>%
  filter(!is.na(indexTime)) %>%
  select(-indexTime, -outcomeTime)

# Ensure the data is clean and ready for modeling
data <- data %>% select(where(not_all_na))
```

```{r}
# Split the data into training and test sets
set.seed(123)
trainIndex <- createDataPartition(data$event_within_threshold, p = .8, 
                                  list = FALSE, 
                                  times = 1)
dataTrain <- data[ trainIndex,]
dataTest  <- data[-trainIndex,]

# Fit logistic regression model
logit_model <- glm(event_within_threshold ~ reserve + quarter + coinType + amountUSD + amount, 
                   data = dataTrain, 
                   family = binomial)

# Predict on test set
logit_predictions <- predict(logit_model, dataTest, type = "response")
logit_pred_class <- ifelse(logit_predictions > 0.5, 1, 0)

# Evaluate model
logit_conf_matrix <- confusionMatrix(factor(logit_pred_class), factor(dataTest$event_within_threshold))
logit_accuracy <- logit_conf_matrix$overall['Accuracy']
logit_roc <- roc(dataTest$event_within_threshold, logit_predictions)
logit_auc <- auc(logit_roc)
```

```{r}
# Fit random forest model
rf_model <- randomForest(event_within_threshold ~ reserve + quarter + coinType + amountUSD + amount, 
                         data = dataTrain, 
                         ntree = 10)

# Predict on test set
rf_predictions <- predict(rf_model, dataTest)
rf_pred_class <- predict(rf_model, dataTest, type = "response")

# Evaluate model
rf_conf_matrix <- confusionMatrix(factor(rf_pred_class), factor(dataTest$event_within_threshold))
rf_accuracy <- rf_conf_matrix$overall['Accuracy']
rf_roc <- roc(dataTest$event_within_threshold, as.numeric(rf_predictions))
rf_auc <- auc(rf_roc)

```


```{r}
# Combine the results into a summary data frame
classification_results <- data.frame(
  Model = c("Logistic Regression", "Random Forest"),
  Accuracy = c(logit_accuracy, rf_accuracy),
  AUC = c(logit_auc, rf_auc)
)

# Print the results summary
print(classification_results)

# Present the results in a table format
kable(classification_results, caption = "Classification Experiment Results")

```